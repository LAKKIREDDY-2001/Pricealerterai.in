<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Price Alert</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Unbounded:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Dashboard-specific overrides */
        .browser-window {
            height: 100vh;
            max-width: 100%;
            border-radius: 0;
        }
        
        body {
            padding: 0;
            display: block;
            align-items: stretch;
            justify-content: flex-start;
        }
        
        .scene {
            display: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }
        
        .success-message {
            background: #dcfce7;
            color: #16a34a;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="browser-window">
        <!-- Browser Header -->
        <header class="browser-header">
            <div class="window-dots">
                <span class="dot red"></span>
                <span class="dot yellow"></span>
                <span class="dot green"></span>
            </div>
            <div class="nav-arrows">
                <i class="fa fa-arrow-left"></i>
                <i class="fa fa-arrow-right"></i>
            </div>
            <div class="address-bar">
                <i class="fa fa-lock"></i>
                <span>aipricealert.com/dashboard</span>
            </div>
            <div class="user-menu">
                <span id="welcome">User</span>
                <a href="{{ url_for('home') }}" class="logout-btn" id="logoutBtn">
                    <i class="fa fa-sign-out-alt"></i>
                </a>
            </div>
        </header>

        <!-- Main Viewport -->
        <div class="viewport">
            <!-- Sidebar -->
            <aside class="app-sidebar">
                <!-- Logo Section -->
                <div class="app-logo">
                    <div class="logo-icon">
                        <i class="fa fa-bell"></i>
                    </div>
                    <div class="logo-text">
                        <span class="logo-name">AI Price Alert</span>
                        <span class="logo-tagline">Smart Tracking</span>
                    </div>
                </div>

                <!-- New Alert Button -->
                <button class="action-btn" onclick="focusInput()" style="width: 100%; margin-bottom: 24px; justify-content: center;">
                    <i class="fa fa-plus"></i>
                    New Alert
                </button>

                <!-- Navigation Items -->
                <nav class="nav-items">
                    <a class="nav-item active" data-view="trackers">
                        <i class="fa fa-list"></i>
                        My Trackers
                    </a>
                    <a class="nav-item" data-view="live">
                        <i class="fa fa-bolt"></i>
                        Live Price
                    </a>
                    <a class="nav-item" data-view="trends">
                        <i class="fa fa-chart-line"></i>
                        Price Trends
                    </a>
                    <a class="nav-item" data-view="settings">
                        <i class="fa fa-cog"></i>
                        Settings
                    </a>
                </nav>

                <!-- Sidebar Stats Card -->
                <div class="sidebar-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="sidebarTotal">0</span>
                        <span class="stat-label">Trackers</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="sidebarActive">0</span>
                        <span class="stat-label">Active</span>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="app-main">
                <!-- Top Bar -->
                <div class="trackers-header">
                    <h2>
                        <i class="fa fa-bell"></i>
                        Start Tracking
                    </h2>
                    <div class="trackers-actions">
                        <div class="auto-refresh-active" id="autoRefreshBadge">
                            <i class="fa fa-sync"></i>
                            Auto: ON
                        </div>
                        <button class="btn-secondary small" id="toggleAutoBtn">
                            <i class="fa fa-pause"></i>
                            Pause
                        </button>
                    </div>
                </div>

                <!-- Error/Success Messages -->
                <div class="error-message" id="errorMsg"></div>
                <div class="success-message" id="successMsg"></div>

                <!-- Input Section -->
                <div class="input-container" style="max-width: 100%; padding-top: 0; margin-bottom: 32px;">
                    <div class="demo-card" style="padding: 24px;">
                        <div class="demo-inputs">
                            <input type="url" id="productUrl" class="product-input" placeholder="Paste product URL from Amazon, Flipkart, Myntra, Ajio, Meesho..." />
                            <input type="number" id="targetPrice" class="product-input" style="width: 180px;" placeholder="Target price" min="1" step="0.01" />
                            <button class="btn btn-primary" id="addTrackerBtn">
                                <i class="fa fa-rocket"></i>
                                Start AI Tracking
                            </button>
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-secondary small" id="refreshAllBtn">
                                <i class="fa fa-sync"></i>
                                Refresh All
                            </button>
                            <a href="{{ url_for('home') }}" class="btn btn-secondary small" style="text-decoration: none;">
                                <i class="fa fa-home"></i>
                                Back to Home
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Supported Marketplaces -->
                <div class="supported-sites" style="margin-bottom: 32px;">
                    <span class="tag"><i class="fab fa-amazon"></i> Amazon</span>
                    <span class="tag"><i class="fa fa-shopping-bag"></i> Flipkart</span>
                    <span class="tag"><i class="fa fa-tshirt"></i> Myntra</span>
                    <span class="tag"><i class="fa fa-tag"></i> Ajio</span>
                    <span class="tag"><i class="fa fa-box"></i> Meesho</span>
                    <span class="tag"><i class="fa fa-shopping-cart"></i> Snapdeal</span>
                    <span class="tag"><i class="fa fa-store"></i> Tata CliQ</span>
                    <span class="tag"><i class="fa fa-plug"></i> Reliance Digital</span>
                    <span class="tag"><i class="fa fa-heart"></i> Nykaa</span>
                    <span class="tag"><i class="fa fa-laptop"></i> Croma</span>
                    <span class="tag"><i class="fa fa-shopping-basket"></i> JioMart</span>
                    <span class="tag"><i class="fa fa-store-alt"></i> Shopsy</span>
                    <span class="tag"><i class="fa fa-couch"></i> Pepperfry</span>
                    <span class="tag"><i class="fa fa-carrot"></i> BigBasket</span>
                </div>

                <!-- Stats Cards -->
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <i class="fa fa-list"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-number" id="statTotal">0</span>
                            <span class="stat-desc">Total Trackers</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <i class="fa fa-bolt"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-number" id="statActive">0</span>
                            <span class="stat-desc">Active</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon gold">
                            <i class="fa fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-number" id="statReached">0</span>
                            <span class="stat-desc">Target Reached</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--gradient-purple);">
                            <i class="fa fa-percentage"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-number" id="statSavings">0%</span>
                            <span class="stat-desc">Avg Savings</span>
                        </div>
                    </div>
                </div>

                <!-- Trackers Section -->
                <section class="trackers-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fa fa-list"></i>
                            Your Trackers
                        </h2>
                        <button class="btn-danger small" id="clearAllBtn" style="padding: 10px 16px;">
                            <i class="fa fa-trash"></i>
                            Clear All
                        </button>
                    </div>
                    <div class="trackers-grid" id="trackerGrid">
                        <!-- Trackers will be rendered here -->
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast">
        <div class="toast-icon success">
            <i class="fa fa-check"></i>
        </div>
        <div class="toast-content">
            <strong>Success!</strong>
            <span id="toastMsg">Tracker added successfully</span>
        </div>
    </div>

    <script>
        // API Base URL
        const API_BASE = window.location.origin;
        
        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/api/user`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    window.location.href = '{{ url_for("login") }}';
                    return null;
                }
                return await response.json();
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '{{ url_for("login") }}';
                return null;
            }
        }

        // Get user info
        let currentUser = null;

        // Storage for trackers
        let trackers = [];
        let refreshTimer = null;
        let autoOn = true;

        // Show error message
        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        // Show success message
        function showSuccess(msg) {
            const el = document.getElementById('successMsg');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // Show toast notification
        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        // Parse product name from URL
        const parseName = (url) => {
            try {
                const u = new URL(url);
                const path = decodeURIComponent(u.pathname.replace(/\/+$/, ''));
                const slug = path.split('/').filter(Boolean).pop() || u.hostname;
                return slug.replace(/[-_]+/g, ' ').replace(/\b\w/g, c => c.toUpperCase()).slice(0, 110);
            } catch {
                return 'Product';
            }
        };

        // Get store name from URL
        const getStoreName = (url) => {
            try {
                const hostname = new URL(url).hostname.toLowerCase();
                if (hostname.includes('amazon')) return 'Amazon';
                if (hostname.includes('flipkart')) return 'Flipkart';
                if (hostname.includes('myntra')) return 'Myntra';
                if (hostname.includes('ajio')) return 'Ajio';
                if (hostname.includes('meesho')) return 'Meesho';
                if (hostname.includes('snapdeal')) return 'Snapdeal';
                if (hostname.includes('tatacliq')) return 'Tata CliQ';
                if (hostname.includes('reliance')) return 'Reliance Digital';
                if (hostname.includes('croma')) return 'Croma';
                if (hostname.includes('nykaa')) return 'Nykaa';
                if (hostname.includes('jiomart')) return 'JioMart';
                return 'Store';
            } catch {
                return 'Store';
            }
        };

        // Fetch price from API
        async function fetchPrice(url) {
            try {
                const response = await fetch(`${API_BASE}/get-price`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                return data;
            } catch (error) {
                console.error('Price fetch error:', error);
                // Fallback to random price for demo
                return {
                    price: Math.random() * 1000 + 100,
                    currency: 'USD',
                    currency_symbol: '$',
                    productName: parseName(url)
                };
            }
        }

        // Load trackers from API
        async function loadTrackers() {
            try {
                const response = await fetch(`${API_BASE}/api/trackers`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error('Failed to load trackers');
                }
                trackers = await response.json();
            } catch (error) {
                console.error('Load trackers error:', error);
                trackers = [];
            }
            render();
        }

        // Save tracker to API
        async function addTracker(url, targetPrice) {
            try {
                // First fetch the current price
                const priceData = await fetchPrice(url);
                
                const response = await fetch(`${API_BASE}/api/trackers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        url: url,
                        productName: priceData.productName || parseName(url),
                        currentPrice: priceData.price,
                        targetPrice: targetPrice,
                        currency: priceData.currency || 'USD',
                        currencySymbol: priceData.currency_symbol || '$'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to add tracker');
                }
                
                await loadTrackers();
                showToast('Tracker added successfully! Starting AI monitoring...');
            } catch (error) {
                console.error('Add tracker error:', error);
                showError('Failed to add tracker: ' + error.message);
            }
        }

        // Delete tracker from API
        async function deleteTracker(id) {
            try {
                const response = await fetch(`${API_BASE}/api/trackers`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ id })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete tracker');
                }
                
                await loadTrackers();
                showToast('Tracker deleted successfully');
            } catch (error) {
                console.error('Delete error:', error);
                showError('Failed to delete tracker');
            }
        }

        // Clear all trackers from API
        async function clearAllTrackers() {
            try {
                for (const tracker of trackers) {
                    await fetch(`${API_BASE}/api/trackers`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ id: tracker.id })
                    });
                }
                await loadTrackers();
                showToast('All trackers cleared');
            } catch (error) {
                console.error('Clear all error:', error);
                showError('Failed to clear trackers');
            }
        }

        // Render stats
        const renderStats = () => {
            const total = trackers.length;
            const reached = trackers.filter(t => t.currentPrice <= t.targetPrice).length;
            const active = total - reached;
            const avgSavings = total ? (trackers.reduce((a, t) => {
                const savings = ((t.currentPrice - t.targetPrice) / t.currentPrice * 100);
                return a + (savings > 0 ? savings : 0);
            }, 0) / total) : 0;

            // Update sidebar stats
            document.getElementById('sidebarTotal').textContent = total;
            document.getElementById('sidebarActive').textContent = active;

            // Update main stats
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statActive').textContent = active;
            document.getElementById('statReached').textContent = reached;
            document.getElementById('statSavings').textContent = avgSavings > 0 ? avgSavings.toFixed(0) + '%' : '0%';
        };

        // Render trackers
        const render = () => {
            renderStats();
            const box = document.getElementById('trackerGrid');
            
            if (!trackers.length) {
                box.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-bell-slash empty-icon"></i>
                        <h3>No Trackers Yet</h3>
                        <p>Add your first product URL above to start tracking prices</p>
                        <button class="action-btn" onclick="focusInput()">
                            <i class="fa fa-plus"></i>
                            Add First Tracker
                        </button>
                    </div>
                `;
                return;
            }

            box.innerHTML = trackers.map((t) => {
                const reached = t.currentPrice <= t.targetPrice;
                const savings = ((t.currentPrice - t.targetPrice) / t.currentPrice * 100).toFixed(1);
                const symbol = t.currencySymbol || 'â‚¹';
                
                return `
                    <div class="tracker-card">
                        <div class="tracker-header">
                            <div class="tracker-info">
                                <div class="tracker-logo">
                                    <i class="fa fa-shopping-bag"></i>
                                </div>
                                <div>
                                    <div class="tracker-name">${t.productName || 'Product'}</div>
                                    <div class="tracker-url">
                                        <i class="fa fa-store"></i> ${getStoreName(t.url)}
                                    </div>
                                </div>
                            </div>
                            <button class="tracker-delete" onclick="handleDelete(${t.id})" title="Delete">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                        <a href="${t.url}" target="_blank" class="tracker-url" style="margin-bottom: 16px; display: block;">
                            ${t.url}
                        </a>
                        <div class="tracker-prices">
                            <div class="price-info current">
                                <span class="price-label">Current Price</span>
                                <span class="price-amount">${symbol}${t.currentPrice.toFixed(2)}</span>
                            </div>
                            <div class="price-info target">
                                <span class="price-label">Target Price</span>
                                <span class="price-amount">${symbol}${t.targetPrice.toFixed(2)}</span>
                            </div>
                            <div class="price-status ${reached ? 'status-reached' : 'status-active'}">
                                ${reached ? '<i class="fa fa-check-circle"></i> Target Reached' : '<i class="fa fa-clock"></i> Active'}
                            </div>
                        </div>
                        <div class="tracker-footer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                            <span style="font-size: 12px; color: var(--text-secondary);">
                                <i class="fa fa-calendar"></i> ${new Date(t.createdAt).toLocaleDateString()}
                            </span>
                            <span style="font-size: 12px; color: ${reached ? 'var(--success)' : 'var(--accent-orange)'};">
                                ${reached ? 'You save ' + symbol + (t.currentPrice - t.targetPrice).toFixed(2) : savings + '% below current'}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        };

        // Handle delete (wrapper for API call)
        window.handleDelete = async (id) => {
            if (confirm('Are you sure you want to delete this tracker?')) {
                await deleteTracker(id);
            }
        };

        // Randomize price for demo (when API unavailable)
        const randomize = (v) => {
            const drift = (Math.random() - 0.5) * Math.max(3, v * 0.03);
            return Math.max(1, v + drift);
        };

        // Refresh all trackers
        const refreshAll = async () => {
            // In a real app, this would call the API to refresh prices
            // For demo, we just randomize locally
            trackers = trackers.map(t => ({ ...t, currentPrice: randomize(t.currentPrice) }));
            render();
        };

        // Focus input
        const focusInput = () => {
            document.getElementById('productUrl').focus();
        };

        // Add tracker button click
        document.getElementById('addTrackerBtn').addEventListener('click', async () => {
            const url = document.getElementById('productUrl').value.trim();
            const target = parseFloat(document.getElementById('targetPrice').value);
            
            if (!url || !/^https?:\/\//i.test(url)) {
                alert('Please enter a valid product URL');
                return;
            }
            if (!Number.isFinite(target) || target <= 0) {
                alert('Please enter a valid target price');
                return;
            }

            const btn = document.getElementById('addTrackerBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="loading-spinner"></i> Adding...';
            
            await addTracker(url, target);
            
            document.getElementById('productUrl').value = '';
            document.getElementById('targetPrice').value = '';
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fa fa-rocket"></i> Start AI Tracking';
        });

        // Enter key for target price
        document.getElementById('targetPrice').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('addTrackerBtn').click();
        });

        // Refresh all button
        document.getElementById('refreshAllBtn').addEventListener('click', refreshAll);

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await fetch(`${API_BASE}/logout`, {
                        credentials: 'include'
                    });
                } catch (error) {
                    console.error('Logout error:', error);
                }
                window.location.href = '{{ url_for("home") }}';
            }
        });

        // Auto refresh toggle
        const startAuto = () => {
            clearInterval(refreshTimer);
            refreshTimer = setInterval(refreshAll, 5000);
        };

        document.getElementById('toggleAutoBtn').addEventListener('click', () => {
            autoOn = !autoOn;
            const badge = document.getElementById('autoRefreshBadge');
            const btn = document.getElementById('toggleAutoBtn');
            
            if (autoOn) {
                startAuto();
                badge.innerHTML = '<i class="fa fa-sync"></i> Auto: ON';
                btn.innerHTML = '<i class="fa fa-pause"></i> Pause';
            } else {
                clearInterval(refreshTimer);
                badge.innerHTML = '<i class="fa fa-pause"></i> Auto: OFF';
                btn.innerHTML = '<i class="fa fa-play"></i> Resume';
            }
        });

        // Clear all button
        document.getElementById('clearAllBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to delete all trackers? This action cannot be undone.')) {
                clearAllTrackers();
            }
        });

        // Navigation items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Initialize
        async function init() {
            currentUser = await checkAuth();
            if (!currentUser) return;
            
            document.getElementById('welcome').textContent = currentUser.username || currentUser.email;
            
            await loadTrackers();
            startAuto();
        }

        init();
    </script>
</body>
</html>

